#!/bin/bash

##
## with EC2
##

web() {
  apt install -y $(apt search php | grep "^php7" | grep -v snmp | awk -F'/' '{print $1}' | xargs) nginx nginx-extras
  rm -f /etc/nginx/sites-enabled/default
  cp -pr /var/site/projects/_/conf.d /etc/nginx
  ln -sfn /run/php/php7*sock /var/site/run/php/php-fpm.sock
  chown -R www-data. /var/log/nginx
  systemctl restart nginx
}

cli() {
  apt install -y \
    curl dnsutils net-tools whois nmap traceroute \
    nfs-common cifs-utils exfat-utils sshfs \
    git subversion vim tmux dstat peco \
    at expect zip unzip colordiff speedtest-cli \
    cmatrix sl \
    mariadb-client libpng-dev nasm
}

gui() {
  apt install -y terminator conky mysql-workbench polari gimp
}

iNodejs() {
  curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash
  . ~/.bashrc
  LATEST=$(nvm ls-remote | grep 'Latest LTS' | tail -1 | awk '{print $1}')
  nvm install $LATEST
  nvm alias default $LATEST
  nvm use $LATEST
  node --version
  npm --version
  id
}

useFunction() {
  user=$(grep -w 1000 /etc/passwd | awk -F: '{print $1}')
  name=$1
  type $name | tail -$(echo $(type $name | wc -l)-1 | bc) > /tmp/$name
  sudo -u $user bash -c ". /tmp/$name && $name"
  rm /tmp/$name
}

java() {
  apt install -y openjdk-8-jdk-headless openjdk-8-jre-headless
}

account() {
  user=jobscale
  usermod -l $user -m -d /home/$user ubuntu
  ln -s /var/site/cloud/land.pem /home/$user/.ssh/id_rsa
  echo "$user ALL=(ALL) NOPASSWD:ALL" | tee -a /etc/sudoers.d/70-users
  systemctl restart sshd
}

system() {
  dd if=/dev/zero of=/var/swap bs=1M count=4K
  chmod 0600 /var/swap
  mkswap /var/swap
  swapon /var/swap
  echo '/var/swap none swap sw 0 0' | tee -a /etc/fstab
}

main() {
  date +'START    my-init %Y-%m-%d %H:%M:%S'
#  web
#  account
#  system
  cli
  date +'FINISHED my-init %Y-%m-%d %H:%M:%S'
}

main | tee -a /var/log/cloud-my-init.log

